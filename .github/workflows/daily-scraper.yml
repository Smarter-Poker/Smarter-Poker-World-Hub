name: Venue Tournament Scraper (Every 3 Days)

on:
  schedule:
    # Run every 3 days at 6am UTC (midnight CST)
    - cron: '0 6 */3 * *'
  workflow_dispatch:
    # Allow manual trigger with options
    inputs:
      mode:
        description: 'Scraping mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
          - setup-only
          - sync-urls-only
          - verify-venues
      state:
        description: 'Filter by state (optional, e.g., TX, NV, FL)'
        required: false
        type: string

jobs:
  scrape-venue-tournaments:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hour max for full scrape of 777 venues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Sync Verified URLs to Database
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode != 'setup-only' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ”„ Syncing verified PokerAtlas URLs to database..."
          node scripts/sync-verified-urls.js

      - name: Skip Scraping (URL Sync Only)
        if: ${{ github.event.inputs.mode == 'sync-urls-only' }}
        run: echo "âœ… URL sync complete. Skipping scraping as requested."

      - name: Run Full Pipeline (Scheduled)
        if: ${{ github.event_name == 'schedule' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ° Running full venue tournament scraping pipeline..."
          echo "ğŸ“… Triggered: $(date -u)"
          echo ""
          echo "ğŸ“ Source 1: PokerAtlas"
          node scripts/run-full-pipeline.js --scrape-only
          echo ""
          echo "ğŸ“ Source 2: Bravo Poker Live"
          node scripts/scrape-bravo-poker.js || echo "âš ï¸ Bravo scraper had errors (non-fatal)"
          echo ""
          echo "ğŸ“ Source 3: CardPlayer"
          node scripts/scrape-cardplayer.js || echo "âš ï¸ CardPlayer scraper had errors (non-fatal)"

      - name: Run Pipeline (Manual - Full)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'full' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ° Running full pipeline (manual trigger)..."
          echo ""
          echo "ğŸ“ Source 1: PokerAtlas"
          node scripts/run-full-pipeline.js --scrape-only ${{ github.event.inputs.state && format('--state {0}', github.event.inputs.state) || '' }}
          echo ""
          echo "ğŸ“ Source 2: Bravo Poker Live"
          node scripts/scrape-bravo-poker.js || echo "âš ï¸ Bravo scraper had errors (non-fatal)"
          echo ""
          echo "ğŸ“ Source 3: CardPlayer"
          node scripts/scrape-cardplayer.js || echo "âš ï¸ CardPlayer scraper had errors (non-fatal)"
          echo ""
          echo "ğŸ“ Source 4: Hendon Mob"
          node scripts/scrape-hendonmob.js 50 || echo "âš ï¸ Hendon Mob scraper had errors (non-fatal)"

      - name: Run Pipeline (Manual - Test)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'test' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ§ª Running test scrape (10 venues)..."
          node scripts/run-full-pipeline.js --test --scrape-only ${{ github.event.inputs.state && format('--state {0}', github.event.inputs.state) || '' }}

      - name: Run Pipeline (Manual - Setup Only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'setup-only' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ“¦ Running setup only..."
          node scripts/run-full-pipeline.js --setup-only

      - name: Verify Unverified Venues
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'verify-venues' }}
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ğŸ” Running venue verification (checking multiple sources)..."
          node scripts/verify-all-venues.js 100

      - name: Upload scraper logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scraper-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 7

      - name: Upload debug artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts-${{ github.run_number }}
          path: |
            /tmp/venue-*.png
            /tmp/venue-*.html
          retention-days: 3
          if-no-files-found: ignore

      - name: Report Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SCRAPER WORKFLOW COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Mode: ${{ github.event.inputs.mode || 'scheduled-full' }}"
          echo "State Filter: ${{ github.event.inputs.state || 'all' }}"
          echo "Completed at: $(date -u)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
