name: Daily Tournament Scraper

on:
  schedule:
    # Run daily at 4am UTC (11pm EST, 10pm CST, 9pm PST)
    - cron: '0 4 * * *'

  workflow_dispatch:
    # Allow manual triggering from GitHub Actions UI
    inputs:
      mode:
        description: 'Scraping mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - test
          - setup-only
      state:
        description: 'Filter by state (optional, e.g., TX, NV, FL)'
        required: false
        type: string

env:
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  NODE_ENV: production

jobs:
  scrape-tournaments:
    name: Scrape Tournament Data
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour max for full scrape

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Pipeline (Full)
        if: ${{ github.event.inputs.mode == 'full' || github.event_name == 'schedule' }}
        run: |
          echo "ğŸ° Running full tournament scraping pipeline..."
          node scripts/run-full-pipeline.js ${{ github.event.inputs.state && format('--state {0}', github.event.inputs.state) || '' }}

      - name: Run Pipeline (Test)
        if: ${{ github.event.inputs.mode == 'test' }}
        run: |
          echo "ğŸ§ª Running test scrape (10 venues)..."
          node scripts/run-full-pipeline.js --test ${{ github.event.inputs.state && format('--state {0}', github.event.inputs.state) || '' }}

      - name: Run Pipeline (Setup Only)
        if: ${{ github.event.inputs.mode == 'setup-only' }}
        run: |
          echo "ğŸ“¦ Running setup only..."
          node scripts/run-full-pipeline.js --setup-only

      - name: Report Results
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š SCRAPER WORKFLOW COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Mode: ${{ github.event.inputs.mode || 'scheduled' }}"
          echo "State Filter: ${{ github.event.inputs.state || 'none' }}"
          echo "Completed at: $(date -u)"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: scrape-tournaments
    if: failure()

    steps:
      - name: Log Failure
        run: |
          echo "âŒ Tournament scraper failed!"
          echo "Check the logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
